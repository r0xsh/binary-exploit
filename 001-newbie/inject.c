#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>

// Binary offset
#define OFFSET 0x123c

void usage(char* cmd) {
  fprintf(stderr, "%s <PID>\n", cmd);
  exit(EXIT_FAILURE);
}

void inject(unsigned long pid, unsigned long address) {

  int fd;
  char file[20];

  char buffer[2];
  // Payload. OPcode NOP = 90
  char payload[] = {90, 90};

  // Open memory file.
  sprintf(file, "/proc/%lu/mem", pid);
  if ((fd = open(file, O_RDWR)) < 0){
    fprintf(stderr, "Cannot open memory module");
    exit(EXIT_FAILURE);
  }

  // Seek to ASLR base addres + binary offset
  lseek(fd, address + OFFSET, SEEK_SET);

  // Read 2 chars
  read(fd, buffer, 2);

  // read() moved the cursor by 2, so we move it back
  lseek(fd, -2, SEEK_CUR);

  // Check if the signature is valid
  if (buffer[0] == 0x75 && buffer[1] == 0x1B)
  {
    printf("Signature found !\n");
    // Write new opcode
    if (write(fd, payload, sizeof(payload)) < 0) {
      fprintf(stderr, "Cannot write to memory");
      exit(EXIT_FAILURE);
    }

    printf("Exploit injected :)\n");

  } else {
    fprintf(stderr, "Cannot inject the payload, skipped !\n");
  }

  close(fd);
}



unsigned long ASLRSolver(unsigned long pid) {

  FILE *fd;
  char file[21];
  unsigned long address;
  char *buffer;

  // Open memory maps file. See man 5 proc
  sprintf(file, "/proc/%lu/maps", pid);
  if ((fd = fopen(file, "r")) == NULL){
    fprintf(stderr, "Cannot open memory maps\n");
    exit(EXIT_FAILURE);
  }

  // Read 50 chars
  buffer = (char*) malloc(50 * sizeof(char));
  fgets(buffer, 50, fd);

  // Split at first '-' char
  buffer[strcspn(buffer, "-")] = 0;

  // Convert string hex value to unsigned long
  address = strtoul(buffer, NULL, 16);

  fclose(fd);
  free(buffer);

  return address;

}

int main(int ac, char** av) {

  unsigned long pid;
  unsigned long base_address;

  if (ac < 2) {
    usage(av[0]);
  } else {
    pid = strtoul(av[1], NULL, 10);
  }

  printf("Attaching to PID %lu\n", pid);

  // Resolve ASLR base address
  base_address = ASLRSolver(pid);

  printf("ASLR base address found\n");

  // Inject the bytes to the memory
  inject(pid, base_address);

  return 0;

}


